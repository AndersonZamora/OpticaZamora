
@{
    ViewBag.Title = "VentaPaciente";
}

<div class="modal-content ">
    <div class="col-md-12">
        <form action="/Optica/VentaPaciente" method="post">

            @*<input name="NumeroVneta" disabled="disabled" value="@Model.NumeroVneta" />*@
            @foreach (var item in ViewBag.PacinetesDetalle)
            {

                <h2 class="text-center text-info pt-5">EXPEDIENTE</h2>
                <hr />
                <div class="form-grou col-md-4">
                    <h3 class="text-info text-center  ">Codigo de Expediente</h3>
                    <h2 class="text-center">@item.CodigoExpediente</h2>
                    <input hidden="hidden" name="CodigoExpediente" value="@item.CodigoExpediente" />
                    <input hidden="hidden" name="ExpedienteId" value="@item.IdExpediente" />
                    <input hidden="hidden" name="Detalles[@ViewBag.Index].VentaId" value="@Model.IdVenta" />

                    @*  name="Detalles[@ViewBag.Index].ProductoNombre" *@
                </div>
                <div class="form-grou col-md-4">
                    <h3 class="text-info text-center ">Paciente</h3>
                    <h2 class="text-center">@item.Paciente.Nombres @item.Paciente.Apellidos</h2>
                    <input hidden="hidden" name="NombrePacienteExpediente" value="@item.Paciente.Nombres" />
                    <input hidden="hidden" name="ApellidoPacienteExpediente" value="@item.Paciente.Apellidos" />
                    <input hidden="hidden" name="DNIPacienteExpediente" value="@item.Paciente.NumeroDocumento" />
                </div>
                <div class="form-grou col-md-4">
                    <h3 class="text-info text-center ">Doctor</h3>
                    <h2 class="text-center">@item.Doctor.Nombres @item.Doctor.Apellidos</h2>

                </div>
                <div class="col-md-12  form-grou">
                    <br />
                    <h3 class="text-center text-info">Fecha de Consulta</h3>
                    <h3 class="text-center">@item.Fecha</h3>
                </div>
                <br />

                <div class="col-md-12  pb-4 form-grou">
                    <br />
                    <h3 class="text-center text-info ">Diagnostico y Recomendacion</h3>
                    <h2 class="text-center">@item.Recomendacion</h2>
                </div>
                <h2 class="text-center text-info pt-5">VENTA</h2>

                <div class="form-grou col-md-6">
                    <h3 class="text-info text-center  ">Codigo de Venta</h3>
                    <h4 class="text-center">
                        <input disabled="disabled" class="text-center form-control" name="NumeroVneta" value="@Model.NumeroVneta" />
                    </h4>

                </div>

                <div class="form-grou col-md-6">
                    <h3 class="text-info text-center  ">Fecha de la Venta</h3>
                    <h4 class="text-center">
                        <input type="date" class="text-center form-control" name="Fecha" value="@Model.Fecha" />
                    </h4>
                </div>
                <div class="row pt-4">
                    <div class="col-md-12">
                        <h1 class="text-center ">Productos</h1>
                    </div>
                    <div class="col-md-6">
                        <h3 class="text-center">Seleccione un Producto</h3>
                        <select class="form-control text-center" id="ProductoAelegir">
                            <option>--- Seleccione un producto ---</option>
                            @foreach (var item2 in ViewBag.Producto)
                            {
                                <option class="form-control" value="@item2.IdProducto">@item2.Nombre</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6 ">
                        <h3 class="text-center">Busque un Producto</h3>
                        <input placeholder="Ingrese  Codigo del Producto" class="text-center form-control" />
                    </div>
                    <div class="col-md-12 pt-4 pb-4">
                        <a href="#" id="BtnAgregarProducto" class="btn btn_add btn-success btn-block">Agregar</a>
                    </div>
                    <div class="col-md-12 pt-4">
                        <table class="table table-bordered" id="first_table">
                            <thead>
                                <tr>
                                    @*<th>Id</th>*@
                                    <th>Producto</th>
                                    <th>Categoria</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Stock</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="BodyProductos">
                             
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Total</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td><span id="total">0</span> <input class="form-control" type="hidden" id="total_final" name="Total" value="0" readonly /></td>
                                    <td>&nbsp;</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="col-md-12 center pb-4 form-grou">

                    <button class="btn btn-lg btn-primary">Guardar</button>
                </div>
                <br />
            }
        </form>
    </div>
</div>
<script>

    $('#BtnAgregarProducto').click(function (e) {
        e.preventDefault();
        var index = $('#BodyProductos').find('tr').length;

        $.ajax({
            url: '/Optica/ItemConsutla?id=' + $('#ProductoAelegir').val() + "&index=" + index,
            type: 'get'
        }).done(function (response) {
            $("#BodyProductos").append(response);
        });

    });
    function Calcular(ele) {
        var cantidad = 0, precunit = 0, totalitem = 0;
        var tr = ele.parentNode.parentNode;
        var nodes = tr.childNodes;

        for (var x = 0; x < nodes.length; x++) {

            if (nodes[x].firstChild.id == 'cantidad[]') {
                cantidad = parseFloat(nodes[x].firstChild.value, 10);
            }
            if (nodes[x].firstChild.id == 'precunit[]') {
                precunit = parseFloat(nodes[x].firstChild.value, 10);
            }
            if (nodes[x].firstChild.id == 'totalitem[]') {
                anterior = nodes[x].firstChild.value;
                totalitem = parseFloat((precunit * cantidad), 10);
                nodes[x].firstChild.value = totalitem;
            }
        }
        // Resultado final de cada fila ERROR, al editar o eliminar una fila
        var total = document.getElementById("total");
        if (total.innerHTML == 'NaN') {
            total.innerHTML = 0;
        }
        total.innerHTML = parseFloat(total.innerHTML) + totalitem - anterior;
    }

 
</script>
